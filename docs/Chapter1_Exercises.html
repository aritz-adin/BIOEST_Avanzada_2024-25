<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aritz Adin y Jaione Etxeberria">

<title>BIOEST AVANZADA 2024-25 - Chapter 1: Linear Mixed Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">BIOEST AVANZADA 2024-25</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Program</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Chapter1_Exercises.html" rel="" target="" aria-current="page">
 <span class="menu-text">Chapter 1 - LMM</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#exercise-1-plasma-data" id="toc-exercise-1-plasma-data" class="nav-link active" data-scroll-target="#exercise-1-plasma-data">Exercise 1: plasma data</a>
  <ul class="collapse">
  <li><a href="#load-the-data-intored-in-the-plasma.txt-file-convert-volunteer-and-treatment-variables-to-factor-and-make-a-descriptive-plot-to-visualize-differences-between-treatments-andor-subjects." id="toc-load-the-data-intored-in-the-plasma.txt-file-convert-volunteer-and-treatment-variables-to-factor-and-make-a-descriptive-plot-to-visualize-differences-between-treatments-andor-subjects." class="nav-link" data-scroll-target="#load-the-data-intored-in-the-plasma.txt-file-convert-volunteer-and-treatment-variables-to-factor-and-make-a-descriptive-plot-to-visualize-differences-between-treatments-andor-subjects.">1. Load the data intored in the <code>Plasma.txt</code> file, convert <code>Volunteer</code> and <code>Treatment</code> variables to factor, and make a descriptive plot to visualize differences between treatments and/or subjects.</a></li>
  <li><a href="#which-variable-should-be-included-as-a-fixed-effect-and-which-as-a-random-effect-make-a-design-plot-to-visually-compare-the-magnitude-of-the-effects-of-the-treatment-and-volunteer-factors." id="toc-which-variable-should-be-included-as-a-fixed-effect-and-which-as-a-random-effect-make-a-design-plot-to-visually-compare-the-magnitude-of-the-effects-of-the-treatment-and-volunteer-factors." class="nav-link" data-scroll-target="#which-variable-should-be-included-as-a-fixed-effect-and-which-as-a-random-effect-make-a-design-plot-to-visually-compare-the-magnitude-of-the-effects-of-the-treatment-and-volunteer-factors.">2. Which variable should be included as a fixed effect, and which as a random effect? Make a <em>design plot</em> to visually compare the magnitude of the effects of the <code>Treatment</code> and <code>Volunteer</code> factors.</a></li>
  <li><a href="#write-the-linear-mixed-model-equation." id="toc-write-the-linear-mixed-model-equation." class="nav-link" data-scroll-target="#write-the-linear-mixed-model-equation.">3. Write the linear mixed model equation.</a></li>
  <li><a href="#test-if-random-effects-are-necessary." id="toc-test-if-random-effects-are-necessary." class="nav-link" data-scroll-target="#test-if-random-effects-are-necessary.">4. Test if random effects are necessary.</a></li>
  <li><a href="#check-if-the-treatment-effect-is-significant." id="toc-check-if-the-treatment-effect-is-significant." class="nav-link" data-scroll-target="#check-if-the-treatment-effect-is-significant.">5. Check if the treatment effect is significant.</a></li>
  <li><a href="#verify-whether-the-model-assumptions-are-satisfied." id="toc-verify-whether-the-model-assumptions-are-satisfied." class="nav-link" data-scroll-target="#verify-whether-the-model-assumptions-are-satisfied.">6. Verify whether the model assumptions are satisfied.</a></li>
  <li><a href="#examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-compute-the-predicted-random-effects-and-fitted-values." id="toc-examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-compute-the-predicted-random-effects-and-fitted-values." class="nav-link" data-scroll-target="#examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-compute-the-predicted-random-effects-and-fitted-values.">7. Examine the model results (estimated fixed effects and variance components). Compute and interpret the intra-class correlation coefficient. Compute the predicted random effects and fitted values.</a></li>
  </ul></li>
  <li><a href="#exercise-2-spider-data" id="toc-exercise-2-spider-data" class="nav-link" data-scroll-target="#exercise-2-spider-data">Exercise 2: spider data</a>
  <ul class="collapse">
  <li><a href="#load-the-data-intored-in-the-spiders.txt-file-and-convert-plot-variable-to-factor.-make-descriptive-graphs-to-visualize-relationships-between-the-variable-of-interest-and-the-explanatory-variables-taking-into-account-the-plot-factor." id="toc-load-the-data-intored-in-the-spiders.txt-file-and-convert-plot-variable-to-factor.-make-descriptive-graphs-to-visualize-relationships-between-the-variable-of-interest-and-the-explanatory-variables-taking-into-account-the-plot-factor." class="nav-link" data-scroll-target="#load-the-data-intored-in-the-spiders.txt-file-and-convert-plot-variable-to-factor.-make-descriptive-graphs-to-visualize-relationships-between-the-variable-of-interest-and-the-explanatory-variables-taking-into-account-the-plot-factor.">1. Load the data intored in the <code>Spiders.txt</code> file and convert <code>Plot</code> variable to factor. Make descriptive graphs to visualize relationships between the variable of interest and the explanatory variables, taking into account the <code>Plot</code> factor.</a></li>
  <li><a href="#test-if-random-effects-are-necessary" id="toc-test-if-random-effects-are-necessary" class="nav-link" data-scroll-target="#test-if-random-effects-are-necessary">2. Test if random effects are necessary</a></li>
  <li><a href="#check-which-environmental-variables-should-be-included-in-the-model." id="toc-check-which-environmental-variables-should-be-included-in-the-model." class="nav-link" data-scroll-target="#check-which-environmental-variables-should-be-included-in-the-model.">3. Check which environmental variables should be included in the model.</a></li>
  <li><a href="#fit-the-final-linear-mixed-model-and-write-its-equation" id="toc-fit-the-final-linear-mixed-model-and-write-its-equation" class="nav-link" data-scroll-target="#fit-the-final-linear-mixed-model-and-write-its-equation">4. Fit the final linear mixed model and write its equation</a></li>
  <li><a href="#verify-whether-the-model-assumptions-are-satisfied.-1" id="toc-verify-whether-the-model-assumptions-are-satisfied.-1" class="nav-link" data-scroll-target="#verify-whether-the-model-assumptions-are-satisfied.-1">5. Verify whether the model assumptions are satisfied.</a></li>
  <li><a href="#examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-make-a-plot-of-observed-vs-predicted-diversity-index-values." id="toc-examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-make-a-plot-of-observed-vs-predicted-diversity-index-values." class="nav-link" data-scroll-target="#examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-make-a-plot-of-observed-vs-predicted-diversity-index-values.">6. Examine the model results (estimated fixed effects and variance components). Compute and interpret the intra-class correlation coefficient. Make a plot of observed vs predicted diversity index values.</a></li>
  </ul></li>
  <li><a href="#exercise-3-split-plot-experiment-on-varieties-of-oats" id="toc-exercise-3-split-plot-experiment-on-varieties-of-oats" class="nav-link" data-scroll-target="#exercise-3-split-plot-experiment-on-varieties-of-oats">Exercise 3: split-plot experiment on varieties of oats</a>
  <ul class="collapse">
  <li><a href="#test-if-random-effects-are-necessary-1" id="toc-test-if-random-effects-are-necessary-1" class="nav-link" data-scroll-target="#test-if-random-effects-are-necessary-1">1. Test if random effects are necessary</a></li>
  <li><a href="#choose-the-correct-structure-for-the-fixed-effects" id="toc-choose-the-correct-structure-for-the-fixed-effects" class="nav-link" data-scroll-target="#choose-the-correct-structure-for-the-fixed-effects">2. Choose the correct structure for the fixed effects</a></li>
  <li><a href="#fit-the-final-linear-mixed-model-and-write-its-equation-1" id="toc-fit-the-final-linear-mixed-model-and-write-its-equation-1" class="nav-link" data-scroll-target="#fit-the-final-linear-mixed-model-and-write-its-equation-1">3. Fit the final linear mixed model and write its equation</a></li>
  <li><a href="#verify-whether-the-model-assumptions-are-satisfied.-2" id="toc-verify-whether-the-model-assumptions-are-satisfied.-2" class="nav-link" data-scroll-target="#verify-whether-the-model-assumptions-are-satisfied.-2">4. Verify whether the model assumptions are satisfied.</a></li>
  <li><a href="#examine-the-model-results." id="toc-examine-the-model-results." class="nav-link" data-scroll-target="#examine-the-model-results.">5. Examine the model results.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 1: Linear Mixed Models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aritz Adin y Jaione Etxeberria </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Jan/2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="exercise-1-plasma-data" class="level1">
<h1>Exercise 1: plasma data</h1>
<p>Below are the results of a randomised complete block experiment to compare the effects on the clotting time of plasma (mins) of four different methods for the treatment of plasma (<em>material extracted from Gallagher, 2023</em>). Samples of plasma were taken from a random sample of 8 volunteers and were subjected to all 4 treatments.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;"><strong>Treatment</strong></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Volunteer</strong></td>
<td style="text-align: center;"><strong>1</strong></td>
<td style="text-align: center;"><strong>2</strong></td>
<td style="text-align: center;"><strong>3</strong></td>
<td style="text-align: center;"><strong>4</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>1</strong></td>
<td style="text-align: center;">8.4</td>
<td style="text-align: center;">9.4</td>
<td style="text-align: center;">9.8</td>
<td style="text-align: center;">12.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>2</strong></td>
<td style="text-align: center;">12.8</td>
<td style="text-align: center;">15.2</td>
<td style="text-align: center;">12.9</td>
<td style="text-align: center;">14.4</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>3</strong></td>
<td style="text-align: center;">9.6</td>
<td style="text-align: center;">9.1</td>
<td style="text-align: center;">11.2</td>
<td style="text-align: center;">9.8</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>4</strong></td>
<td style="text-align: center;">9.8</td>
<td style="text-align: center;">8.8</td>
<td style="text-align: center;">9.9</td>
<td style="text-align: center;">12.0</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>5</strong></td>
<td style="text-align: center;">8.4</td>
<td style="text-align: center;">8.2</td>
<td style="text-align: center;">8.5</td>
<td style="text-align: center;">8.5</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>6</strong></td>
<td style="text-align: center;">8.6</td>
<td style="text-align: center;">9.9</td>
<td style="text-align: center;">9.8</td>
<td style="text-align: center;">10.9</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>7</strong></td>
<td style="text-align: center;">8.9</td>
<td style="text-align: center;">9.0</td>
<td style="text-align: center;">9.2</td>
<td style="text-align: center;">10.4</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>8</strong></td>
<td style="text-align: center;">7.9</td>
<td style="text-align: center;">8.1</td>
<td style="text-align: center;">8.2</td>
<td style="text-align: center;">10.0</td>
</tr>
</tbody>
</table>
<section id="load-the-data-intored-in-the-plasma.txt-file-convert-volunteer-and-treatment-variables-to-factor-and-make-a-descriptive-plot-to-visualize-differences-between-treatments-andor-subjects." class="level3">
<h3 class="anchored" data-anchor-id="load-the-data-intored-in-the-plasma.txt-file-convert-volunteer-and-treatment-variables-to-factor-and-make-a-descriptive-plot-to-visualize-differences-between-treatments-andor-subjects.">1. Load the data intored in the <code>Plasma.txt</code> file, convert <code>Volunteer</code> and <code>Treatment</code> variables to factor, and make a descriptive plot to visualize differences between treatments and/or subjects.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Plasma <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"Plasma.txt"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Plasma, <span class="at">n=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Volunteer Treatment Clotting
1         1         1      8.4
2         1         2      9.4
3         1         3      9.8
4         1         4     12.2
5         2         1     12.8
6         2         2     15.2
7         2         3     12.9
8         2         4     14.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Plasma<span class="sc">$</span>Volunteer <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Plasma<span class="sc">$</span>Volunteer)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Plasma<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Plasma<span class="sc">$</span>Treatment)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Plasma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   32 obs. of  3 variables:
 $ Volunteer: Factor w/ 8 levels "1","2","3","4",..: 1 1 1 1 2 2 2 2 3 3 ...
 $ Treatment: Factor w/ 4 levels "1","2","3","4": 1 2 3 4 1 2 3 4 1 2 ...
 $ Clotting : num  8.4 9.4 9.8 12.2 12.8 15.2 12.9 14.4 9.6 9.1 ...</code></pre>
</div>
</div>
<p>We can make a descriptive plot of the data using the ggplot2 package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Plasma, <span class="fu">aes</span>(<span class="at">x=</span>Clotting, <span class="at">y=</span>Volunteer, <span class="at">color=</span>Treatment)) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Clotting time (mins)"</span>, <span class="at">y=</span><span class="st">"Volunteer"</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We observe systematic differences between subjects and treatments.</p>
</section>
<section id="which-variable-should-be-included-as-a-fixed-effect-and-which-as-a-random-effect-make-a-design-plot-to-visually-compare-the-magnitude-of-the-effects-of-the-treatment-and-volunteer-factors." class="level3">
<h3 class="anchored" data-anchor-id="which-variable-should-be-included-as-a-fixed-effect-and-which-as-a-random-effect-make-a-design-plot-to-visually-compare-the-magnitude-of-the-effects-of-the-treatment-and-volunteer-factors.">2. Which variable should be included as a fixed effect, and which as a random effect? Make a <em>design plot</em> to visually compare the magnitude of the effects of the <code>Treatment</code> and <code>Volunteer</code> factors.</h3>
<ul>
<li><p>We want to compare these particular types of treatments (<em>experimental factor</em>), so we use fixed effects for the <code>Treatment</code> factor.</p></li>
<li><p>The eight subjects represents a sample from the population about which we wish to make inferences (<em>random factor</em>), so we use random effects to model the <code>Volunteer</code> factor.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.design</span>(Clotting <span class="sc">~</span> Treatment <span class="sc">+</span> Volunteer, <span class="at">data=</span>Plasma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Average clotting time for each level of the factors <code>Treatment</code> and <code>Volunteer</code></figcaption>
</figure>
</div>
</div>
</div>
<ul>
<li><p>We see that the variability associated with the <code>Treatment</code> factor is lower than the variability associated with the <code>Volunteer</code> factor.</p></li>
<li><p>We also see that the average clotting time according to the treatment type is in the order <span class="math inline">\(T1 \leq T2 \leq T3 \leq T4\)</span>.</p></li>
</ul>
</section>
<section id="write-the-linear-mixed-model-equation." class="level3">
<h3 class="anchored" data-anchor-id="write-the-linear-mixed-model-equation.">3. Write the linear mixed model equation.</h3>
<p><span class="math display">\[y_{ij} = \beta_j + u_i + \epsilon_{ij}, \quad i=1,\ldots,8, \quad j=1,\ldots,4,\]</span> <span class="math display">\[u_i \sim N(0,\sigma^2_u), \quad \epsilon_{ij} \sim N(0,\sigma^2)\]</span> where</p>
<ul>
<li><span class="math inline">\(\beta_j\)</span> is the mean clotting time from the <span class="math inline">\(j\)</span>-th treatment</li>
<li><span class="math inline">\(u_i\)</span> is a random variable associated with the <span class="math inline">\(i\)</span>-th individual</li>
<li><span class="math inline">\(\epsilon_{ij}\)</span> are independent random errors</li>
</ul>
<p>Using matrix notation</p>
<p><span class="math display">\[\boldsymbol{y} = \begin{pmatrix} \boldsymbol{I}_4 \\ \vdots \\ \boldsymbol{I}_4 \end{pmatrix} \begin{pmatrix} \beta_1 \\ \vdots \\ \beta_4 \end{pmatrix} +
\begin{pmatrix}
\boldsymbol{1}_4 &amp; \boldsymbol{0} &amp; \ldots &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{1}_4 &amp; \ldots &amp; \boldsymbol{0} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\boldsymbol{0} &amp; \boldsymbol{0} &amp; \cdots &amp; \boldsymbol{1}_4 \\
\end{pmatrix} \boldsymbol{u} + \boldsymbol{\epsilon}\]</span></p>
<!-- or using Kronecker products -->
<!-- $$y = (\boldsymbol{1}_8 \otimes \boldsymbol{I}_4)\boldsymbol{\beta} + (\boldsymbol{I}_8 \otimes \boldsymbol{1}_4)\boldsymbol{u} + \boldsymbol{\epsilon}$$ -->
</section>
<section id="test-if-random-effects-are-necessary." class="level3">
<h3 class="anchored" data-anchor-id="test-if-random-effects-are-necessary.">4. Test if random effects are necessary.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the models ##</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plasma.null <span class="ot">&lt;-</span> <span class="fu">lm</span>(Clotting <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Treatment, <span class="at">data=</span>Plasma)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plasma.lmer <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Clotting <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Treatment <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Volunteer), <span class="at">data=</span>Plasma)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">## LRT for the variance component sigma2_u ##</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>LRT <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(<span class="fu">logLik</span>(plasma.null,<span class="at">REML=</span>T)<span class="sc">-</span><span class="fu">logLik</span>(plasma.lmer,<span class="at">REML=</span>T))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pchisq</span>(LRT,<span class="at">df=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.290542e-07</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## We can also use the AIC/BIC to compare the models ##</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>Models <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">plasma.null=</span>plasma.null, <span class="at">plasma.lmer=</span>plasma.lmer)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">AIC=</span><span class="fu">lapply</span>(Models, AIC), <span class="at">BIC=</span><span class="fu">lapply</span>(Models, BIC))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            AIC      BIC     
plasma.null 134.8699 142.1986
plasma.lmer 107.8852 116.6796</code></pre>
</div>
</div>
</section>
<section id="check-if-the-treatment-effect-is-significant." class="level3">
<h3 class="anchored" data-anchor-id="check-if-the-treatment-effect-is-significant.">5. Check if the treatment effect is significant.</h3>
<p>We compare nested models (with and without <code>Treatment</code> factor) using the LRT with the <code>anova()</code> function base on fitting through the ML method</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Clotting <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Volunteer), <span class="at">data=</span>Plasma, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>M2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Clotting <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Treatment <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Volunteer), <span class="at">data=</span>Plasma, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(M1,M2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: Plasma
Models:
M1: Clotting ~ -1 + (1 | Volunteer)
M2: Clotting ~ -1 + Treatment + (1 | Volunteer)
   npar    AIC   BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)    
M1    2 145.57 148.5 -70.784  141.568                         
M2    6 107.80 116.6 -47.902   95.804 45.764  4  2.757e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>We conclude that the <code>Treatment</code> effect is significant.</p>
</section>
<section id="verify-whether-the-model-assumptions-are-satisfied." class="level3">
<h3 class="anchored" data-anchor-id="verify-whether-the-model-assumptions-are-satisfied.">6. Verify whether the model assumptions are satisfied.</h3>
<p><strong>a) Assessing assumptions on the within-group errors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plasma.lmer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plasma.lmer, Volunteer <span class="sc">~</span> <span class="fu">resid</span>(., <span class="at">type=</span><span class="st">"pearson"</span>), <span class="at">abline=</span><span class="dv">0</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">resid</span>(plasma.lmer, <span class="at">type=</span><span class="st">"pearson"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(res)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  res
W = 0.94578, p-value = 0.1093</code></pre>
</div>
</div>
<ul>
<li>We observe that the residuals are centred at zero and normally distributed, but there seems to be a lack of constant variance in the residuals (heterocedasticy).</li>
</ul>
<p><strong>b) Assessing assumptions on the random-effects</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">ranef</span>(plasma.lmer)<span class="sc">$</span>Volunteer)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(u)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  u
W = 0.76565, p-value = 0.01215</code></pre>
</div>
</div>
<ul>
<li>Again, the are some issues with the assumptions for the random effects.</li>
</ul>
</section>
<section id="examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-compute-the-predicted-random-effects-and-fitted-values." class="level3">
<h3 class="anchored" data-anchor-id="examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-compute-the-predicted-random-effects-and-fitted-values.">7. Examine the model results (estimated fixed effects and variance components). Compute and interpret the intra-class correlation coefficient. Compute the predicted random effects and fitted values.</h3>
<p><strong>a) Estimated fixed effects and 95% confidence intervals</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(plasma.lmer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Treatment1 Treatment2 Treatment3 Treatment4 
    9.3000     9.7125     9.9375    11.0250 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(plasma.lmer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4 x 4 Matrix of class "dpoMatrix"
           Treatment1 Treatment2 Treatment3 Treatment4
Treatment1  0.4141183  0.3321317  0.3321317  0.3321317
Treatment2  0.3321317  0.4141183  0.3321317  0.3321317
Treatment3  0.3321317  0.3321317  0.4141183  0.3321317
Treatment4  0.3321317  0.3321317  0.3321317  0.4141183</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>beta.CI <span class="ot">&lt;-</span> <span class="fu">confint</span>(plasma.lmer, <span class="at">parm=</span><span class="st">"beta_"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>beta.CI</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              2.5 %   97.5 %
Treatment1 8.000009 10.59999
Treatment2 8.412509 11.01249
Treatment3 8.637509 11.23749
Treatment4 9.725009 12.32499</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(Plasma<span class="sc">$</span>Volunteer))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(Plasma<span class="sc">$</span>Treatment))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>j, <span class="fu">fixef</span>(plasma.lmer), <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">xaxt=</span><span class="st">"n"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim=</span><span class="fl">0.5</span><span class="sc">+</span><span class="fu">c</span>(<span class="dv">0</span>,j), <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(beta.CI))<span class="sc">*</span><span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">1.1</span>),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Type"</span>, <span class="at">ylab=</span><span class="st">"Estimated fixed effects"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="dv">1</span><span class="sc">:</span>j, <span class="at">labels=</span><span class="fu">rownames</span>(beta.CI))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(<span class="dv">1</span><span class="sc">:</span>j, beta.CI[,<span class="st">"2.5 %"</span>], <span class="dv">1</span><span class="sc">:</span>j, beta.CI[,<span class="st">"97.5 %"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can use the <code>emmeans()</code> function to <em>compute pairwise comparisons between treatments</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(plasma.lmer, pairwise<span class="sc">~</span>Treatment, <span class="at">infer=</span>T)<span class="sc">$</span>contrasts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> contrast                estimate    SE df lower.CL upper.CL t.ratio p.value
 Treatment1 - Treatment2   -0.412 0.405 21    -1.54   0.7162  -1.019  0.7405
 Treatment1 - Treatment3   -0.637 0.405 21    -1.77   0.4912  -1.574  0.4139
 Treatment1 - Treatment4   -1.725 0.405 21    -2.85  -0.5963  -4.260  0.0018
 Treatment2 - Treatment3   -0.225 0.405 21    -1.35   0.9037  -0.556  0.9440
 Treatment2 - Treatment4   -1.312 0.405 21    -2.44  -0.1838  -3.241  0.0189
 Treatment3 - Treatment4   -1.087 0.405 21    -2.22   0.0412  -2.686  0.0616

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 
Conf-level adjustment: tukey method for comparing a family of 4 estimates 
P value adjustment: tukey method for comparing a family of 4 estimates </code></pre>
</div>
</div>
<p>Two out of six pairwise comparisons are statistically significant at the 5% level:</p>
<ul>
<li>The mean clotting time for treatment 4 is significantly longer than that for treatments 1 and 2.</li>
</ul>
<p><strong>b) Estimated variance components and 95% confidence intervals</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(plasma.lmer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Groups    Name        Std.Dev.
 Volunteer (Intercept) 1.63005 
 Residual              0.80987 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(plasma.lmer, <span class="at">parm=</span><span class="st">"theta_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           2.5 %   97.5 %
.sig01 0.9562558 2.794239
.sigma 0.5849697 1.035247</code></pre>
</div>
</div>
<p>Intra-class correlation coefficient: <span class="math inline">\(\rho=\frac{\sigma^2_u}{\sigma^2_u+\sigma^2} = \frac{1.63^2}{1.63^2+0.81^2}=0.802\)</span>. Which means that 80.1% of the overall variability can be attributed to the differences between the individuals.</p>
<p><strong>c) Compute the predicted random effects and fitted values</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">ranef</span>(plasma.lmer)<span class="sc">$</span>Volunteer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      1        2           3        4         5          6
(Intercept) -0.04120702 3.608557 -0.06475388 0.123621 -1.501113 -0.1824882
                     7         8
(Intercept) -0.5827849 -1.359832</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>plasma.fitted <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Plasma,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Clotting.fit=</span><span class="fu">fitted</span>(plasma.lmer),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">error=</span><span class="fu">resid</span>(plasma.lmer))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plasma.fitted, <span class="at">n=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Volunteer Treatment Clotting Clotting.fit       error
1         1         1      8.4     9.258793 -0.85879298
2         1         2      9.4     9.671293 -0.27129298
3         1         3      9.8     9.896293 -0.09629298
4         1         4     12.2    10.983793  1.21620702
5         2         1     12.8    12.908557 -0.10855720
6         2         2     15.2    13.321057  1.87894280
7         2         3     12.9    13.546057 -0.64605720
8         2         4     14.4    14.633557 -0.23355720</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plasma.fitted<span class="sc">$</span>Clotting, plasma.fitted<span class="sc">$</span>Clotting.fit,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Observed"</span>, <span class="at">ylab=</span><span class="st">"Predicted"</span>, <span class="at">main=</span><span class="st">"Clotting time (mins)"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">20</span>), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="exercise-2-spider-data" class="level1">
<h1>Exercise 2: spider data</h1>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0378112705002021">Oxbrough et al.&nbsp;(2005)</a> investigated how spider communities change over forestation cycles in conifer and broadleaf plantations. They identified environmental and structural features of the habitat than can be used as indicators of spider biodiversity. Different plots were surveyed, each comprising 5 to 7 sampling sites separated by a minimum of 50 metres. More than 100 species of spiders were observed.</p>
<p>The <code>Spiders.txt</code> file contains some of the data recorded from the original study (<em>material extracted from Zuur et al., 2013</em>). We are interested in analyzing the relationship between the spider diversity in each site with some environmental explanatory variables. The data set contains the following variables:</p>
<ul>
<li><code>DivIndex</code>: Variable of interest. Lower values of this index indicates less abundance of different species.</li>
<li><code>HerbLayer</code>: Percentage of Herb Layer Cover</li>
<li><code>Litter</code>: Percentage of Litter Content</li>
<li><code>GroundVeg</code>: Percentage of Ground Vegetation</li>
<li><code>Plot</code>: Factor indicating the surveyed plot.</li>
</ul>
<section id="load-the-data-intored-in-the-spiders.txt-file-and-convert-plot-variable-to-factor.-make-descriptive-graphs-to-visualize-relationships-between-the-variable-of-interest-and-the-explanatory-variables-taking-into-account-the-plot-factor." class="level3">
<h3 class="anchored" data-anchor-id="load-the-data-intored-in-the-spiders.txt-file-and-convert-plot-variable-to-factor.-make-descriptive-graphs-to-visualize-relationships-between-the-variable-of-interest-and-the-explanatory-variables-taking-into-account-the-plot-factor.">1. Load the data intored in the <code>Spiders.txt</code> file and convert <code>Plot</code> variable to factor. Make descriptive graphs to visualize relationships between the variable of interest and the explanatory variables, taking into account the <code>Plot</code> factor.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>Spiders <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"Spiders.txt"</span>, <span class="at">header=</span>T)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>Spiders<span class="sc">$</span>Plot <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Spiders<span class="sc">$</span>Plot)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Spiders)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   168 obs. of  5 variables:
 $ DivIndex : num  1.05 1.13 1 0.87 0.94 1.01 1.2 0.38 0.71 0.82 ...
 $ HerbLayer: num  0.27 0.45 0.63 0.49 0.32 0.73 0.68 0.2 0.39 0.38 ...
 $ GroundVeg: num  0.01 0.01 0.01 0.01 0.03 0.27 0.15 0.15 0.59 0.35 ...
 $ Litter   : num  0 0 0 0 0 0 0 0.63 0.06 0.49 ...
 $ Plot     : Factor w/ 30 levels "1","2","3","4",..: 1 1 1 1 1 1 1 2 2 2 ...</code></pre>
</div>
</div>
<p>We can make descriptive graphs of the data using the ggplot2 package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Spiders, <span class="fu">aes</span>(<span class="at">x=</span>HerbLayer, <span class="at">y=</span>DivIndex, <span class="at">color=</span>Plot)) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Percentage of Herb Layer Cover"</span>, <span class="at">y=</span><span class="st">"Diversity Index"</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Spiders, <span class="fu">aes</span>(<span class="at">x=</span>Litter, <span class="at">y=</span>DivIndex, <span class="at">color=</span>Plot)) <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Percentage of Litter Content"</span>, <span class="at">y=</span><span class="st">"Diversity Index"</span>) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Spiders, <span class="fu">aes</span>(<span class="at">x=</span>GroundVeg, <span class="at">y=</span>DivIndex, <span class="at">color=</span>Plot)) <span class="sc">+</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Percentage of Ground Vegetation"</span>, <span class="at">y=</span><span class="st">"Diversity Index"</span>) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-13-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Design graph to compare average diversity indexes for each level of the <code>Plot</code> factor</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.design</span>(DivIndex <span class="sc">~</span> Plot, <span class="at">data=</span>Spiders)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="test-if-random-effects-are-necessary" class="level3">
<h3 class="anchored" data-anchor-id="test-if-random-effects-are-necessary">2. Test if random effects are necessary</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the models ##</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>spiders.null <span class="ot">&lt;-</span> <span class="fu">lm</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> GroundVeg, <span class="at">data=</span>Spiders)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>spiders.lmer <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> GroundVeg <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="do">## LRT for the variance component sigma2_u ##</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>LRT <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(<span class="fu">logLik</span>(spiders.null,<span class="at">REML=</span>T)<span class="sc">-</span><span class="fu">logLik</span>(spiders.lmer,<span class="at">REML=</span>T))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pchisq</span>(LRT,<span class="at">df=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0002102636</code></pre>
</div>
</div>
</section>
<section id="check-which-environmental-variables-should-be-included-in-the-model." class="level3">
<h3 class="anchored" data-anchor-id="check-which-environmental-variables-should-be-included-in-the-model.">3. Check which environmental variables should be included in the model.</h3>
<p>We compare nested models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>M0 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>M2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>M3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> GroundVeg <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(M0,M1,M2,M3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: Spiders
Models:
M0: DivIndex ~ 1 + (1 | Plot)
M1: DivIndex ~ 1 + HerbLayer + (1 | Plot)
M2: DivIndex ~ 1 + HerbLayer + Litter + (1 | Plot)
M3: DivIndex ~ 1 + HerbLayer + Litter + GroundVeg + (1 | Plot)
   npar     AIC     BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
M0    3 -186.68 -177.31  96.339  -192.68                          
M1    4 -198.50 -186.01 103.252  -206.50 13.8261  1  0.0002005 ***
M2    5 -205.88 -190.26 107.940  -215.88  9.3759  1  0.0021985 ** 
M3    6 -204.26 -185.52 108.132  -216.26  0.3830  1  0.5360224    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>We conclude that the only the <code>HerbLayer</code> and <code>Litter</code> covariates are statistically significant.</p>
<p>We can also check if a interaction between these two variables should be included in the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>M4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> HerbLayer<span class="sc">*</span>Litter <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders, <span class="at">REML=</span><span class="cn">FALSE</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(M2,M4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: Spiders
Models:
M2: DivIndex ~ 1 + HerbLayer + Litter + (1 | Plot)
M4: DivIndex ~ 1 + HerbLayer + Litter + HerbLayer * Litter + (1 | Plot)
   npar     AIC     BIC logLik deviance  Chisq Df Pr(&gt;Chisq)
M2    5 -205.88 -190.26 107.94  -215.88                     
M4    6 -204.09 -185.34 108.05  -216.09 0.2089  1     0.6476</code></pre>
</div>
</div>
</section>
<section id="fit-the-final-linear-mixed-model-and-write-its-equation" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-final-linear-mixed-model-and-write-its-equation">4. Fit the final linear mixed model and write its equation</h3>
<p>We fit the following linear mixed model <span class="math display">\[y_{ij} = \beta_0 + \beta_1 \times HerbLayer_{ij} + \beta_2 \times Litter_{ij} + u_i + \epsilon_{ij}\]</span> <span class="math display">\[u_i \sim N(0,\sigma^2_u), \quad \epsilon_{ij} \sim N(0,\sigma^2)\]</span> where</p>
<ul>
<li><span class="math inline">\(y_{ij}\)</span> is the diversity index at site <span class="math inline">\(j\)</span> in plot <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(\beta_0\)</span> is a global intercept</li>
<li><span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> are regression coefficients associated with the continuous covariates <code>HerbLayer</code> and <code>Litter</code>, respectively</li>
<li><span class="math inline">\(u_i\)</span> is a random variable associated with the <span class="math inline">\(i\)</span>-th surveyed plot</li>
<li><span class="math inline">\(\epsilon_{ij}\)</span> are independent random errors</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>Model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DivIndex <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> HerbLayer <span class="sc">+</span> Litter <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Plot), <span class="at">data=</span>Spiders)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(Model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: DivIndex ~ 1 + HerbLayer + Litter + (1 | Plot)
   Data: Spiders

REML criterion at convergence: -201.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6298 -0.4518  0.0329  0.5959  2.6373 

Random effects:
 Groups   Name        Variance Std.Dev.
 Plot     (Intercept) 0.004145 0.06438 
 Residual             0.013854 0.11770 
Number of obs: 168, groups:  Plot, 30

Fixed effects:
            Estimate Std. Error t value
(Intercept)  0.93674    0.01994  46.985
HerbLayer    0.16628    0.04301   3.866
Litter      -0.22189    0.07077  -3.135

Correlation of Fixed Effects:
          (Intr) HrbLyr
HerbLayer -0.609       
Litter    -0.278  0.026</code></pre>
</div>
</div>
</section>
<section id="verify-whether-the-model-assumptions-are-satisfied.-1" class="level3">
<h3 class="anchored" data-anchor-id="verify-whether-the-model-assumptions-are-satisfied.-1">5. Verify whether the model assumptions are satisfied.</h3>
<p><strong>a) Assessing assumptions on the within-group errors</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Model, Plot <span class="sc">~</span> <span class="fu">resid</span>(., <span class="at">type=</span><span class="st">"pearson"</span>), <span class="at">abline=</span><span class="dv">0</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">resid</span>(Model, <span class="at">type=</span><span class="st">"pearson"</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(res)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  res
W = 0.96873, p-value = 0.0007681</code></pre>
</div>
</div>
<p><strong>b) Assessing assumptions on the random effects</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">ranef</span>(Model)<span class="sc">$</span>Plot)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(u)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  u
W = 0.96304, p-value = 0.3695</code></pre>
</div>
</div>
</section>
<section id="examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-make-a-plot-of-observed-vs-predicted-diversity-index-values." class="level3">
<h3 class="anchored" data-anchor-id="examine-the-model-results-estimated-fixed-effects-and-variance-components.-compute-and-interpret-the-intra-class-correlation-coefficient.-make-a-plot-of-observed-vs-predicted-diversity-index-values.">6. Examine the model results (estimated fixed effects and variance components). Compute and interpret the intra-class correlation coefficient. Make a plot of observed vs predicted diversity index values.</h3>
<p><strong>a) Estimated fixed effects and 95% confidence intervals</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(Model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)   HerbLayer      Litter 
  0.9367414   0.1662767  -0.2218901 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>beta.CI <span class="ot">&lt;-</span> <span class="fu">confint</span>(Model, <span class="at">parm=</span><span class="st">"beta_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>beta.CI</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  2.5 %     97.5 %
(Intercept)  0.89767549  0.9755674
HerbLayer    0.08255604  0.2501822
Litter      -0.36550678 -0.0822844</code></pre>
</div>
</div>
<p><strong>b) Estimated variance components and 95% confidence intervals</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(Model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name        Std.Dev.
 Plot     (Intercept) 0.064379
 Residual             0.117703</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(Model, <span class="at">parm=</span><span class="st">"theta_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            2.5 %     97.5 %
.sig01 0.03582034 0.09292245
.sigma 0.10450819 0.13254556</code></pre>
</div>
</div>
<p>Intra-class correlation coefficient: <span class="math inline">\(\rho=\frac{\sigma^2_u}{\sigma^2_u+\sigma^2} = \frac{0.0644^2}{0.0644^2+0.1177^2}=0.23\)</span>. Which means that only 23% of the overall variability can be attributed to the differences between the surveyed plots.</p>
<p><strong>c) Compare observed and predicted diversity index values</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>spiders.fitted <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Spiders,</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">DivIndex.fit=</span><span class="fu">fitted</span>(Model),</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">error=</span><span class="fu">resid</span>(Model))</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spiders.fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  DivIndex HerbLayer GroundVeg Litter Plot DivIndex.fit       error
1     1.05      0.27      0.01      0    1    0.9863934  0.06360665
2     1.13      0.45      0.01      0    1    1.0163232  0.11367684
3     1.00      0.63      0.01      0    1    1.0462530 -0.04625298
4     0.87      0.49      0.01      0    1    1.0229742 -0.15297423
5     0.94      0.32      0.03      0    1    0.9947072 -0.05470719
6     1.01      0.73      0.27      0    1    1.0628806 -0.05288065</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(spiders.fitted<span class="sc">$</span>DivIndex, spiders.fitted<span class="sc">$</span>DivIndex.fit,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Observed"</span>, <span class="at">ylab=</span><span class="st">"Predicted"</span>, <span class="at">main=</span><span class="st">"Diversity Index"</span>,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">1.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">1.5</span>))</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>),<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="exercise-3-split-plot-experiment-on-varieties-of-oats" class="level1">
<h1>Exercise 3: split-plot experiment on varieties of oats</h1>
<p>These data have been introduced by <a href="https://www.jstor.org/stable/2983638">Yates (1935)</a> as an example of a split-plot design (<em>material extracted from Durban, 2014</em>). The experimental units were arranged into six block using a <span class="math inline">\(3 \times 4\)</span> full factorial design, with three varieties of oats and four nitrogen concentrations. The term <em>full factorial</em> means that every variety was used with every nitrogen concentration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>Oats <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"Oats.txt"</span>, <span class="at">header=</span>T, <span class="at">stringsAsFactors =</span> T)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Oats, <span class="at">n=</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Block     Variety nitro yield
1      I     Victory   0.0   111
2      I     Victory   0.2   130
3      I     Victory   0.4   157
4      I     Victory   0.6   174
5      I Golden Rain   0.0   117
6      I Golden Rain   0.2   114
7      I Golden Rain   0.4   161
8      I Golden Rain   0.6   141
9      I  Marvellous   0.0   105
10     I  Marvellous   0.2   140
11     I  Marvellous   0.4   118
12     I  Marvellous   0.6   156</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Oats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   72 obs. of  4 variables:
 $ Block  : Factor w/ 6 levels "I","II","III",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ Variety: Factor w/ 3 levels "Golden Rain",..: 3 3 3 3 1 1 1 1 2 2 ...
 $ nitro  : num  0 0.2 0.4 0.6 0 0.2 0.4 0.6 0 0.2 ...
 $ yield  : int  111 130 157 174 117 114 161 141 105 140 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Oats, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">factor</span>(nitro), <span class="at">y=</span>yield, <span class="at">color=</span>Variety)) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group=</span>Variety)) <span class="sc">+</span> </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Nitrogen concentration"</span>, <span class="at">y=</span><span class="st">"Yield"</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Yield of oats by variety and nitrogen level"</span>) <span class="sc">+</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Block, <span class="at">ncol=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Design graph to compare average yields for each level of <code>Block</code>, <code>Variety</code> and <code>nitro</code> factors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.design</span>(yield <span class="sc">~</span> Block<span class="sc">*</span>Variety<span class="sc">*</span><span class="fu">factor</span>(nitro), <span class="at">data=</span>Oats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Chapter1_Exercises_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="test-if-random-effects-are-necessary-1" class="level3">
<h3 class="anchored" data-anchor-id="test-if-random-effects-are-necessary-1">1. Test if random effects are necessary</h3>
<!-- We fit linear mixed models with all the fixed effects and different nested structures of random effects -->
<!-- LRT for the variance component of the `Block` random effect -->
<!-- LRT for the variance component of the `Block:Variety` interaction random effect -->
</section>
<section id="choose-the-correct-structure-for-the-fixed-effects" class="level3">
<h3 class="anchored" data-anchor-id="choose-the-correct-structure-for-the-fixed-effects">2. Choose the correct structure for the fixed effects</h3>
<!-- Again, we compare nested models with different structures of fixed effects -->
<!-- We conclude that only the nitrogen level should be included as a significant fixed effect.  -->
</section>
<section id="fit-the-final-linear-mixed-model-and-write-its-equation-1" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-final-linear-mixed-model-and-write-its-equation-1">3. Fit the final linear mixed model and write its equation</h3>
<!-- We fit the following linear mixed model -->
<!-- $$y_{ijk} = \beta_k + u_i + v_{ij} + \epsilon_{ijk}$$ -->
<!-- $$u_i \sim N(0,\sigma^2_u), \quad v_{ij} \sim N(0,\sigma^2_v), \quad \epsilon_{ijk} \sim N(0,\sigma^2)$$ -->
<!-- where -->
<!-- * $y_{ijk}$ is the yield in block $i$ for oat variety $j$ and nitrogen concentration level $k$ -->
<!-- * $\beta_k$ is the mean yield for nitrogen concentration level $k$ -->
<!-- * $u_i$ is a random variable associated with the $i$-th block -->
<!-- * $v_{ij}$ is a interaction random variable associated with variety $j$ within the $i$-th block -->
<!-- * $\epsilon_{ijk}$ are independent random errors -->
</section>
<section id="verify-whether-the-model-assumptions-are-satisfied.-2" class="level3">
<h3 class="anchored" data-anchor-id="verify-whether-the-model-assumptions-are-satisfied.-2">4. Verify whether the model assumptions are satisfied.</h3>
<p><strong>a) Assessing assumptions on the within-group errors</strong></p>
<p><strong>b) Assessing assumptions on the random-effects</strong></p>
</section>
<section id="examine-the-model-results." class="level3">
<h3 class="anchored" data-anchor-id="examine-the-model-results.">5. Examine the model results.</h3>
<p><strong>a) Estimated fixed effects and 95% confidence intervals</strong></p>
<p><strong>b) Estimated variance components and 95% confidence intervals</strong></p>
<!-- * $\frac{\sigma^2_u}{\sigma^2_u+\sigma^2_v+\sigma^2}=0.425$, which mean that 42.5% of the overall variability can be attributed to the main block effect. -->
<!-- * $\frac{\sigma^2_v}{\sigma^2_u+\sigma^2_v+\sigma^2}=0.246$, which mean that 24.6% of the overall variability can be attributed to the interaction effect. -->
<p><strong>c) Predicted random effects and yield values</strong></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>